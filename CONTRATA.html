<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Monitor de Licitaciones</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
        }
        .header h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        .header .info-box {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            text-align: center;
            max-width: 80%;
            margin-left: auto;
            margin-right: auto;
        }
        .container {
            display: flex;
            flex-direction: column;
            padding: 10px;
        }
        @media (min-width: 601px) {
            .container {
                flex-direction: row;
                gap: 20px;
            }
            .left-column {
                flex: 1;
                max-width: 20%;
            }
            .right-column {
                flex: 2;
                max-width: 80%;
            }
            .filters, .description {
                max-width: 100%;
            }
            .cards {
                flex: 1;
            }
        }
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .filters h2 {
            margin-top: 0;
            font-size: 18px;
        }
        .filters input,
        .filters select,
        .filters button {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
            background-color: rgba(255, 255, 255, 0.8);
        }
        .filters button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border: none;
        }
        .filters button:hover {
            background-color: #0056b3;
        }
        .load-more-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .input-loading-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .input-label {
            font-size: 12px;
            color: #333;
            white-space: nowrap;
        }
        #maxFeedsInput {
            width: 60px;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .progress-indicator {
            font-weight: bold;
            font-size: 14px;
            color: #555;
        }
        #loadMoreButton {
            width: 100%;
            padding: 8px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
			margin-bottom: 20px;
        }
        #loadMoreButton:hover {
            background-color: #0056b3;
        }
        .atom-list-box {
            background-color: #fff;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
        }
        .atom-list-box h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #333;
        }
        .atom-list {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px;
        }
        .atom-list div {
            padding: 5px;
            cursor: pointer;
            color: #007bff;
            font-size: 14px;
            border-bottom: 1px solid #eee;
        }
        .atom-list div:hover {
            background-color: #f9f9f9;
        }
        .atom-list div:last-child {
            border-bottom: none;
        }
        .mobile-toggle-button {
            display: none;
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
            text-align: left;
        }
        .mobile-toggle-button i {
            margin-right: 5px;
        }
        @media (max-width: 600px) {
            .filters, .load-more-container {
                display: none;
            }
            .mobile-toggle-button {
                display: block;
                width: 95%;
                margin: 0 auto;
            }
            .download-box {
                width: 90%;
                margin: 0 auto 20px auto;
            }
            #atomContainer {
                width: 95%;
                margin: 0 auto 20px auto;
            }
            .atom-list-box {
                width: 100%;
            }
        }
        .filters.visible, .load-more-container.visible {
            display: block;
        }
        .description {
            width: 100%;
            max-width: 100%;
            text-align: center;
            box-sizing: border-box;
            margin-top: 10px;
            font-size: 14px;
            color: #555;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .other-platforms-button {
            margin-top: 10px;
            padding: 8px 12px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: block;
            width: 100%;
            text-align: center;
        }
        .other-platforms-button:hover {
            background-color: #218838;
        }
        .cards {
            width: 100%;
        }
        .card {
            background-color: #fff;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .card-header .expediente {
            font-size: 14px;
            color: #333;
        }
        .card-header .actualizado {
            font-size: 12px;
            color: #777;
        }
        .card .objeto {
            margin: 5px 0;
            color: #555;
        }
        .card .cpv {
            display: inline-flex;
            align-items: center;
            margin: 5px 0;
            color: #555;
        }
        .card .cpv .toggle-cpv {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            padding: 0;
            margin-left: 5px;
            display: inline-flex;
            align-items: center;
        }
        .card .cpv .cpv-list-hidden {
            display: none;
            margin-left: 5px;
        }
        .card .cpv .cpv-list-hidden.visible {
            display: inline;
        }
        .card .cliente {
            margin: 5px 0;
            color: #777;
        }
        .card .cliente .ver-perfil {
            font-size: 12px;
            color: #007bff;
            text-decoration: none;
            margin-left: 5px;
        }
        .card .cliente .ver-perfil:hover {
            text-decoration: underline;
        }
        .card .divider {
            border: 0;
            border-top: 1px solid #ddd;
            margin: 10px 0;
        }
        .card-details {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        .card-details p {
            margin: 0;
            color: #555;
        }
        .card-details i {
            margin-right: 5px;
        }
        .fa-phone, .fa-envelope, .fa-map-marker-alt {
            color: #6c8cff;
        }
        .card-details .fa-map-marker-alt {
            color: #6c8cff;
        }
        .ver-licitacion-button {
            background-color: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            text-decoration: none;
            display: inline-block;
            margin-top: 10px;
        }
        .ver-licitacion-button:hover {
            background-color: #218838;
        }
        .toggle-button {
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            border: none;
            margin-top: 10px;
        }
        .toggle-button:hover {
            background-color: #0056b3;
        }
        .document-list {
            display: none;
            margin-top: 10px;
        }
        .document-list.visible {
            display: block;
        }
        .error-message {
            color: red;
            font-weight: bold;
            margin-top: 20px;
            text-align: center;
        }
        .download-box {
            background-color: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        .download-box h4 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #333;
        }
        .download-box p {
            margin: 0 0 15px 0;
            font-size: 14px;
            color: #555;
        }
        .download-button {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .download-button:hover {
            background-color: #218838;
        }
        .download-button i {
            font-size: 16px;
        }
        .estado-anuncio {
            background-color: #fff3cd;
            padding: 1px 4px;
            border-radius: 6px;
            display: inline-block;
        }
        .estado-en-plazo {
            background-color: #d4edda;
            padding: 1px 4px;
            border-radius: 6px;
            display: inline-block;
        }
        .estado-otros {
            background-color: #f8d7da;
            padding: 1px 4px;
            border-radius: 6px;
            display: inline-block;
        }
        .card.ext::after {
            content: "Ext";
            position: absolute;
            bottom: 5px;
            right: -20px;
            background-color: #007bff;
            color: white;
            font-size: 12px;
            font-weight: bold;
            padding: 5px 30px;
            transform: rotate(-45deg);
            opacity: 0.7;
            z-index: 1;
        }
        @media (max-width: 600px) {
            .atom-controls {
                display: none;
            }
            .mobile-toggle-button {
                display: block;
                width: 95%;
                margin: 0 auto 10px auto;
                padding: 10px;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                text-align: left;
            }
            .mobile-toggle-button i {
                margin-right: 5px;
            }
            .atom-controls.visible {
                display: block;
            }
        }
        .atom-switches h4 {
            margin: 0;
            padding: 0;
            font-size: 14px;
            color: #333;
            font-weight: bold;
        }
        .atom-switches {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        .switch {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            height: 14px;
            margin: 0;
            padding: 0;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: relative;
            cursor: pointer;
            width: 36px;
            height: 18px;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 18px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #28a745;
        }
        input:checked + .slider:before {
            transform: translateX(18px);
        }
        .switch-text {
            font-size: 12px;
            color: #333;
            white-space: nowrap;
        }
		.description {
			width: 100%;
			max-width: 100%;
			text-align: center;
			box-sizing: border-box;
			margin-top: 10px;
			font-size: 14px;
			color: #555;
			background-color: #f9f9f9;
			padding: 10px;
			border-radius: 5px;
			border: 1px solid #ddd;
		}
		.description p {
			margin: 0;
			padding-bottom: 5px;
		}
		.atom-links {
			display: flex;
			flex-wrap: wrap;
			justify-content: center;
			gap: 10px;
			margin-top: 5px;
		}
		.atom-links a {
			background-color: #007bff;
			color: white;
			padding: 5px 10px;
			border-radius: 5px;
			text-decoration: none;
			font-size: 12px;
		}
		.atom-links a:hover {
			background-color: #0056b3;
		}
    </style>
</head>
<body>
    <div class="header">
        <h3>Anuncios Licitaciones</h3>
        <div class="info-box">
            Prueba de concepto para comprobar las últimas publicaciones en la Plataforma de Contratación del Estado
        </div>
    </div>
    <div class="container">
        <div class="left-column">
            <button id="toggleFiltersButton" class="mobile-toggle-button">
                <i class="fas fa-filter"></i> Introducir Filtros
            </button>
            <div id="filtersContainer" class="filters">
                <h2>Filtros</h2>
                <input type="text" id="cpvFilter" placeholder="Código CPV">
                <input type="text" id="importeFilter" placeholder="Importe mínimo">
                <input type="text" id="clienteFilter" placeholder="Entidad adjudicadora">
                <input type="text" id="expedienteFilter" placeholder="Nº de Expediente">
                <input type="text" id="ciudadFilter" placeholder="Ciudad">
                <select id="tipoFilter">
                    <option value="">Tipo</option>
                    <option value="1">Suministros</option>
                    <option value="2">Servicios</option>
                    <option value="3">Obras</option>
                    <option value="21">Gestión de Servicios Públicos</option>
                    <option value="31">Concesión de Obras Públicas</option>
                    <option value="40">Colaboración entre el sector público y sector privado</option>
                    <option value="7">Administrativo especial</option>
                    <option value="8">Privado</option>
                    <option value="50">Patrimonial</option>
                    <option value="999">Otros</option>
                </select>
                <select id="estadoFilter">
                    <option value="">Estado</option>
                    <option value="Anuncio Previo">Anuncio Previo</option>
                    <option value="EN PLAZO">EN PLAZO</option>
                    <option value="PENDIENTE DE ADJUDICACION">PENDIENTE DE ADJUDICACION</option>
                    <option value="Adjudicada">Adjudicada</option>
                    <option value="Resuelta">Resuelta</option>
                    <option value="Anulada">Anulada</option>
                </select>
                <select id="procedimientoFilter">
                    <option value="">Tipo de procedimiento</option>
                    <option value="Abierto">Abierto</option>
                    <option value="Restringido">Restringido</option>
                    <option value="Negociado con Publicidad">Negociado con Publicidad</option>
                    <option value="Negociado sin Publicidad">Negociado sin Publicidad</option>
                    <option value="Diálogo Competitivo">Diálogo Competitivo</option>
                    <option value="Contrato Menor">Contrato Menor</option>
                    <option value="Asociación para la Innovación">Asociación para la Innovación</option>
                    <option value="Subasta Electrónica">Subasta Electrónica</option>
                    <option value="Concurso de Proyectos">Concurso de Proyectos</option>
                </select>
                <button onclick="checkNewFeed()">Aplicar Filtros</button>
            </div>
            <button id="toggleAtomButton" class="mobile-toggle-button">
                <i class="fas fa-history"></i> Historial Atoms
            </button>
            <div id="atomContainer" class="load-more-container">
                <div id="atomControls" class="atom-controls">
                    <div class="atom-switches">
                        <h4>Seleccionar base de datos</h4>
                        <label class="switch">
                            <input type="checkbox" id="switchNormal" checked>
                            <span class="slider"></span>
                            <span class="switch-text">PLACE</span>
                        </label>
                        <label class="switch">
                            <input type="checkbox" id="switchMenor" checked>
                            <span class="slider"></span>
                            <span class="switch-text">Contratos menores</span>
                        </label>
                        <label class="switch">
                            <input type="checkbox" id="switchOtras" checked>
                            <span class="slider"></span>
                            <span class="switch-text">Plataformas Externas</span>
                        </label>
                    </div>
                    <div class="input-loading-wrapper">
                        <span class="input-label">Cargar Atoms Nº:</span>
                        <input type="number" id="maxFeedsInput" placeholder="1" min="1" value="1">
                        <div id="progress" class="progress-indicator"></div>
                    </div>
                    <button id="loadMoreButton" onclick="loadSelectedFeeds()">Cargar más historial</button>
                    <div class="atom-list-box">
                        <h4>Atom Cargados</h4>
                        <div id="atomList" class="atom-list"></div>
                    </div>
                </div>
            </div>
			<div class="description">
				<p>La información se recoge de <strong>Códice</strong> en formato XML y se parametriza según el <a href="https://contrataciondelsectorpublico.gob.es/datosabiertos/especificacion-sindicacion.pdf" target="_blank" rel="noopener noreferrer">Manual</a></p>
			<div class="atom-links">
				<a href="https://contrataciondelestado.es/sindicacion/sindicacion_1143/contratosMenoresPerfilesContratantes.atom" target="_blank" rel="noopener noreferrer">Contratos Menores</a>
				<a href="https://contrataciondelestado.es/sindicacion/sindicacion_1044/PlataformasAgregadasSinMenores.atom" target="_blank" rel="noopener noreferrer">Plataformas Externas</a>
				<a href="https://contrataciondelestado.es/sindicacion/sindicacion_643/licitacionesPerfilesContratanteCompleto3.atom" target="_blank" rel="noopener noreferrer">Licitaciones Completo</a>
			</div>
			</div>
            <div class="download-box">
                <h4>Exportar Datos</h4>
                <p>Crea un archivo Excel con los datos de las licitaciones.</p>
                <button onclick="exportToCSV()" class="download-button">
                    <i class="fas fa-file-excel"></i> Descargar Excel
                </button>
            </div>
        </div>
        <div class="right-column">
            <div class="cards">
                <p id="status" style="display: none;">🔍 Cargando datos...</p>
                <p id="error" class="error-message"></p>
                <div id="licitacionesContainer"></div>
            </div>
        </div>
    </div>
    <script>
        const initialFeedUrlNormal = "https://contrataciondelestado.es/sindicacion/sindicacion_643/licitacionesPerfilesContratanteCompleto3.atom";
        const initialFeedUrlMenor = "https://contrataciondelsectorpublico.gob.es/sindicacion/sindicacion_1143/contratosMenoresPerfilesContratantes.atom";
        const initialFeedUrlOtras = "https://contrataciondelsectorpublico.gob.es/sindicacion/sindicacion_1044/PlataformasAgregadasSinMenores.atom";
        const proxyUrl = "https://corsmirror.com/v1?url=";
        const switchNormal = document.getElementById("switchNormal");
        const switchMenor = document.getElementById("switchMenor");
        const switchOtras = document.getElementById("switchOtras");
        switchNormal.addEventListener("change", updateData);
        switchMenor.addEventListener("change", updateData);
        switchOtras.addEventListener("change", updateData);
        let allEntries = [];
        let isProcessing = false;
        let loadedAtoms = [];
        const estadoMapping = {
            "PRE": "Anuncio Previo",
            "PUB": "EN PLAZO",
            "EV": "PENDIENTE DE ADJUDICACION",
            "ADJ": "Adjudicada",
            "RES": "Resuelta",
            "ANUL": "Anulada"
        };
        const procedureCodeMapping = {
            "1": "Abierto",
            "2": "Restringido",
            "3": "Negociado con Publicidad",
            "4": "Negociado sin Publicidad",
            "5": "Diálogo Competitivo",
            "6": "Contrato Menor",
            "7": "Asociación para la Innovación",
            "8": "Subasta Electrónica",
            "9": "Concurso de Proyectos"
        };
        const tipoMapping = {
            "1": "Suministros",
            "2": "Servicios",
            "3": "Obras",
            "21": "Gestión de Servicios Públicos",
            "31": "Concesión de Obras Públicas",
            "40": "Colaboración entre el sector público y sector privado",
            "7": "Administrativo especial",
            "8": "Privado",
            "50": "Patrimonial",
            "999": "Otros"
        };
		document.getElementById("switchNormal").addEventListener("change", saveSwitchStates);
		document.getElementById("switchMenor").addEventListener("change", saveSwitchStates);
		document.getElementById("switchOtras").addEventListener("change", saveSwitchStates);
        document.getElementById("toggleFiltersButton").addEventListener("click", () => {
            const filtersContainer = document.getElementById("filtersContainer");
            filtersContainer.classList.toggle("visible");
        });
        document.getElementById("toggleAtomButton").addEventListener("click", () => {
            const atomContainer = document.getElementById("atomContainer");
            atomContainer.classList.toggle("visible");
        });
        async function updateData() {
            try {
                console.log("Actualizando datos...");
                allEntries = [];
                loadedAtoms = [];
                const maxFeeds = parseInt(document.getElementById("maxFeedsInput").value, 10) || 1;
                if (switchNormal.checked) await loadFeed(initialFeedUrlNormal, "Contratos Normales", maxFeeds);
                if (switchMenor.checked) await loadFeed(initialFeedUrlMenor, "Contratos Menores", maxFeeds);
                if (switchOtras.checked) await loadFeed(initialFeedUrlOtras, "Otras Plataformas", maxFeeds);
                fetchAndDisplayLicitaciones(allEntries);
            } catch (error) {
                console.error("Error en updateData:", error);
                document.getElementById("error").innerText = `❌ Error al actualizar los datos: ${error.message}`;
            }
        }
        function toggleVisibility(button) {
            const content = button.nextElementSibling;
            content.style.display = content.style.display === "block" ? "none" : "block";
            button.textContent = content.style.display === "block" ? "Ocultar Documentos" : "Documentos";
        }
        function toggleCPVVisibility(button) {
            const hiddenContent = button.nextElementSibling;
            hiddenContent.classList.toggle('visible');
            button.innerHTML = hiddenContent.classList.contains('visible')
                ? `<i class="fas fa-minus"></i>`
                : `<i class="fas fa-plus"></i>`;
        }
        function formatDate(dateString) {
            if (!dateString || dateString === "N/A") return "N/A";
            const date = new Date(dateString);
            if (isNaN(date)) return "N/A";
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${day}/${month}/${year} // ${hours}:${minutes}:${seconds}`;
        }
        function formatShortDate(dateString) {
            if (!dateString || dateString === "N/A") return "N/A";
            const date = new Date(dateString);
            if (isNaN(date)) return "N/A";
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        function formatTime(dateString) {
            if (!dateString || dateString === "N/A") return "N/A";
            const date = new Date(dateString);
            if (isNaN(date)) return "N/A";
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        function formatPrice(amount) {
            if (isNaN(amount)) return "N/A";
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }
        async function fetchWithTimeout(url, options = {}, timeout = 15000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            try {
                const response = await fetch(proxyUrl + url, {
                    ...options,
                    signal: controller.signal,
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                throw error;
            }
        }
        async function loadSelectedFeeds() {
            const maxFeeds = parseInt(document.getElementById("maxFeedsInput").value, 10) || 1;
            if (isNaN(maxFeeds)) {
                alert("Por favor, introduce un número válido.");
                return;
            }
            const loadNormal = document.getElementById("switchNormal").checked;
            const loadMenor = document.getElementById("switchMenor").checked;
            const loadOtras = document.getElementById("switchOtras").checked;
            try {
                document.getElementById("status").innerText = "🔍 Cargando datos...";
                document.getElementById("status").style.display = "block";
                document.getElementById("error").innerText = "";
                allEntries = [];
                if (loadNormal) await loadFeed(initialFeedUrlNormal, "Contratos Normales", maxFeeds);
                if (loadMenor) await loadFeed(initialFeedUrlMenor, "Contratos Menores", maxFeeds);
                if (loadOtras) await loadFeed(initialFeedUrlOtras, "Otras Plataformas", maxFeeds);
                allEntries.sort((a, b) => {
                    const dateA = new Date(a.querySelector("updated")?.textContent || 0);
                    const dateB = new Date(b.querySelector("updated")?.textContent || 0);
                    return dateB - dateA;
                });
                updateAtomList();
                fetchAndDisplayLicitaciones(allEntries);
                document.getElementById("status").style.display = "none";
            } catch (error) {
                console.error(error);
                document.getElementById("error").innerText = `❌ Error al cargar más feeds: ${error.message}`;
            }
        }
        async function loadFeed(url, feedName, maxFeeds) {
            try {
                let currentUrl = url;
                let loadedCount = 0;
                while (currentUrl && loadedCount < maxFeeds) {
                    const response = await fetchWithTimeout(currentUrl);
                    if (!response.ok) {
                        throw new Error(`No se pudo obtener el Atom: ${currentUrl}. Estado: ${response.status}`);
                    }
                    const text = await response.text();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(text, "text/xml");
                    const selfLink = xmlDoc.querySelector("link[rel='self']")?.getAttribute("href");
                    const nextLink = xmlDoc.querySelector("link[rel='next']")?.getAttribute("href");
                    const isAlreadyLoaded = loadedAtoms.some(atom => atom.url === selfLink);
                    if (!isAlreadyLoaded) {
                        loadedAtoms.push({ name: feedName, url: selfLink });
                        const feedEntries = Array.from(xmlDoc.querySelectorAll("entry"));
                        feedEntries.forEach(entry => entry.feedName = feedName);
                        allEntries.push(...feedEntries);
                        loadedCount++;
                    }
                    currentUrl = nextLink;
                }
            } catch (error) {
                console.error(error);
                document.getElementById("error").innerText = `❌ Error al cargar el feed ${feedName}: ${error.message}`;
            }
        }
        async function loadAllFeeds() {
            if (isProcessing) return;
            isProcessing = true;
            try {
                document.getElementById("status").innerText = "🔍 Cargando datos...";
                document.getElementById("status").style.display = "block";
                document.getElementById("error").innerText = "";
                await Promise.all([
                    loadFeed(initialFeedUrlNormal, "Contratos Normales"),
                    loadFeed(initialFeedUrlMenor, "Contratos Menores"),
                    loadFeed(initialFeedUrlOtras, "Otras Plataformas")
                ]);
                allEntries.sort((a, b) => {
                    const dateA = new Date(a.querySelector("updated")?.textContent || 0);
                    const dateB = new Date(b.querySelector("updated")?.textContent || 0);
                    return dateB - dateA;
                });
                fetchAndDisplayLicitaciones(allEntries);
                document.getElementById("status").style.display = "none";
            } catch (error) {
                console.error(error);
                document.getElementById("error").innerText = `❌ Error en loadAllFeeds: ${error.message}`;
            } finally {
                isProcessing = false;
            }
        }
        function updateAtomList() {
            const atomListContainer = document.getElementById("atomList");
            atomListContainer.innerHTML = "";
            const groupedAtoms = {
                "Contratos Normales": [],
                "Contratos Menores": [],
                "Otras Plataformas": []
            };
            loadedAtoms.forEach(atom => {
                if (groupedAtoms[atom.name]) {
                    groupedAtoms[atom.name].push(atom);
                }
            });
            for (const [feedName, atoms] of Object.entries(groupedAtoms)) {
                if (atoms.length > 0) {
                    const feedHeader = document.createElement("div");
                    feedHeader.textContent = feedName;
                    feedHeader.style.fontWeight = "bold";
                    feedHeader.style.marginTop = "10px";
                    feedHeader.style.color = "#333";
                    atomListContainer.appendChild(feedHeader);
                    atoms.forEach(atom => {
                        const atomElement = document.createElement("a");
                        const displayUrl = atom.url.replace("https://contrataciondelestado.es/sindicacion/sindicacion_", "");
                        atomElement.textContent = displayUrl;
                        atomElement.href = atom.url;
                        atomElement.target = "_blank";
                        atomElement.style.display = "block";
                        atomElement.style.padding = "5px";
                        atomElement.style.color = "#007bff";
                        atomElement.style.textDecoration = "none";
                        atomElement.style.borderBottom = "1px solid #eee";
                        atomElement.style.cursor = "pointer";
                        atomElement.addEventListener("mouseenter", () => {
                            atomElement.style.backgroundColor = "#f9f9f9";
                        });
                        atomElement.addEventListener("mouseleave", () => {
                            atomElement.style.backgroundColor = "transparent";
                        });
                        atomListContainer.appendChild(atomElement);
                    });
                }
            }
        }
        function checkNewFeed() {
            fetchAndDisplayLicitaciones(allEntries);
        }
		function convertToNumber(value) {
			const numericValue = value.replace(/\./g, '').replace(',', '.');
			return parseFloat(numericValue) || 0;
		}
        function loadSwitchStates() {
			const switchNormal = document.getElementById("switchNormal");
			const switchMenor = document.getElementById("switchMenor");
			const switchOtras = document.getElementById("switchOtras");

            switchNormal.checked = localStorage.getItem('switchNormal') !== 'false';
			switchMenor.checked = localStorage.getItem('switchMenor') !== 'false';
			switchOtras.checked = localStorage.getItem('switchOtras') !== 'false';
		}
        function saveSwitchStates() {
			const switchNormal = document.getElementById("switchNormal");
			const switchMenor = document.getElementById("switchMenor");
			const switchOtras = document.getElementById("switchOtras");

			localStorage.setItem('switchNormal', switchNormal.checked);
			localStorage.setItem('switchMenor', switchMenor.checked);
			localStorage.setItem('switchOtras', switchOtras.checked);
		}
    
        function exportToCSV() {
            const cpvFilter = document.getElementById("cpvFilter").value.toLowerCase();
            const importeFilterValue = document.getElementById("importeFilter").value;
            const importeFilter = importeFilterValue ? convertToNumber(importeFilterValue) : 0;
            const clienteFilter = document.getElementById("clienteFilter").value.toLowerCase();
            const expedienteFilter = document.getElementById("expedienteFilter").value.toLowerCase();
            const ciudadFilter = document.getElementById("ciudadFilter").value.toLowerCase();
            const estadoFilter = document.getElementById("estadoFilter").value;
            const procedimientoFilter = document.getElementById("procedimientoFilter").value;
            const tipoFilter = document.getElementById("tipoFilter").value;
            const filteredEntries = allEntries.filter(entry => {
                const cpvElements = entry.getElementsByTagName("cbc:ItemClassificationCode");
                const cpvs = Array.from(cpvElements).map(el => el.textContent.toLowerCase());
                const importeElement = entry.getElementsByTagName("cbc:TotalAmount")[0];
                const importe = importeElement ? parseFloat(importeElement.textContent) : 0;
                const clienteElement = entry.getElementsByTagName("cac:PartyName")[0];
                const clienteName = clienteElement ? clienteElement.getElementsByTagName("cbc:Name")[0]?.textContent.toLowerCase() : "N/A";
                const contractNotificationElement = entry.getElementsByTagName("cbc:ContractFolderID")[0];
                const contractNotification = contractNotificationElement ? contractNotificationElement.textContent.toLowerCase() : "N/A";
                const ciudadElement = entry.getElementsByTagName("cbc:CityName")[0];
                const ciudad = ciudadElement ? ciudadElement.textContent.toLowerCase() : "N/A";
                const estadoElement = entry.getElementsByTagName("cbc-place-ext:ContractFolderStatusCode")[0];
                const estadoCode = estadoElement ? estadoElement.textContent : "N/A";
                const estado = estadoMapping[estadoCode] || "N/A";
                const procedureCodeElement = entry.getElementsByTagName("cbc:ProcedureCode")[0];
                const procedureCode = procedureCodeElement ? procedureCodeMapping[procedureCodeElement.textContent] || "N/A" : "N/A";
                const tipoElement = entry.getElementsByTagName("cbc:TypeCode")[0];
                const tipoCode = tipoElement ? tipoElement.textContent : "N/A";
                return (cpvFilter === "" || cpvs.some(cpv => cpv.includes(cpvFilter))) &&
                    (importe >= importeFilter) &&
                    (clienteFilter === "" || clienteName.includes(clienteFilter)) &&
                    (expedienteFilter === "" || contractNotification.includes(expedienteFilter)) &&
                    (ciudadFilter === "" || ciudad.includes(ciudadFilter)) &&
                    (estadoFilter === "" || estado === estadoFilter) &&
                    (procedimientoFilter === "" || procedureCode === procedimientoFilter) &&
                    (tipoFilter === "" || tipoCode === tipoFilter);
            });
            if (filteredEntries.length === 0) {
                alert("No hay datos para exportar.");
                return;
            }
            const headers = [
                "N Expediente", "Ver Licitacion", "Titulo", "Importe", "Cliente", "Estado", "Fecha Final", "Hora Final",
                "Contacto (Email)", "CPV", "Tipo de Procedimiento", "Tipo de Contrato", "Lotes"
            ];
            const rows = filteredEntries.map(entry => {
                const expediente = entry.getElementsByTagNameNS("*", "ContractFolderID")[0]?.textContent || "N/A";
                const link = entry.querySelector("link")?.getAttribute("href") || "#";
                const titulo = (entry.querySelector("title")?.textContent || "N/A").substring(0, 255);
                const importeElement = entry.getElementsByTagNameNS("*", "TotalAmount")[0];
                const importe = importeElement ? parseFloat(importeElement.textContent) : 0;
                const formattedImporte = formatPrice(importe);
                const clienteElement = entry.getElementsByTagNameNS("*", "PartyName")[0];
                const clienteName = clienteElement ? clienteElement.getElementsByTagNameNS("*", "Name")[0]?.textContent : "N/A";
                const estadoElement = entry.getElementsByTagNameNS("*", "ContractFolderStatusCode")[0];
                const estado = estadoElement ? estadoElement.textContent : "N/A";
                const fechaFinalElement = entry.getElementsByTagNameNS("*", "TenderSubmissionDeadlinePeriod")[0]?.getElementsByTagNameNS("*", "EndDate")[0];
                const horaFinalElement = entry.getElementsByTagNameNS("*", "TenderSubmissionDeadlinePeriod")[0]?.getElementsByTagNameNS("*", "EndTime")[0];
                let fechaFinal = "N/A";
                let horaFinal = "N/A";
                if (fechaFinalElement && fechaFinalElement.textContent) {
                    const fechaCompleta = fechaFinalElement.textContent.trim();
                    const [year, month, day] = fechaCompleta.split('-');
                    fechaFinal = `${day}/${month}/${year}`;
                }
                if (horaFinalElement && horaFinalElement.textContent) {
                    const horaCompleta = horaFinalElement.textContent.trim();
                    const [hours, minutes] = horaCompleta.split(':');
                    horaFinal = `${hours}:${minutes}`;
                }
                const cpvElements = entry.getElementsByTagNameNS("*", "ItemClassificationCode");
                const cpvs = Array.from(cpvElements).map(el => el.textContent).join(", ");
                const procedureCodeElement = entry.getElementsByTagNameNS("*", "ProcedureCode")[0];
                const procedureCode = procedureCodeElement ? procedureCodeMapping[procedureCodeElement.textContent] || "N/A" : "N/A";
                const tipoElement = entry.getElementsByTagNameNS("*", "TypeCode")[0];
                const tipoCode = tipoElement ? tipoElement.textContent : "N/A";
                const tipo = tipoMapping[tipoCode] || "N/A";
                const loteElements = entry.getElementsByTagNameNS("*", "ProcurementProjectLot");
                const lotes = Array.from(loteElements).map(lote => {
                    const idLote = lote.getElementsByTagNameNS("*", "ID")[0]?.textContent || "N/A";
                    const precioElement = lote.getElementsByTagNameNS("*", "TaxExclusiveAmount")[0];
                    const precio = precioElement ? formatPrice(parseFloat(precioElement.textContent)) : "N/A";
                    return `Lote ${idLote}: ${precio}`;
                }).join("; ");
                const emailElement = entry.getElementsByTagNameNS("*", "ElectronicMail")[0];
                const email = emailElement ? emailElement.textContent : "N/A";
                return [
                    expediente, link, titulo, formattedImporte, clienteName, estado, fechaFinal, horaFinal,
                    email, cpvs, procedureCode, tipo, lotes
                ];
            });
            const csvContent = [
                headers.join(";"),
                ...rows.map(row => row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(";"))
            ].join("\n");
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const now = new Date();
            const timestamp = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, "0")}${now.getDate().toString().padStart(2, "0")}_${now.getHours().toString().padStart(2, "0")}${now.getMinutes().toString().padStart(2, "0")}${now.getSeconds().toString().padStart(2, "0")}`;
            const filename = `licitaciones_${timestamp}.csv`;
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    async function fetchAndDisplayLicitaciones(entries) {
        try {
            let cardsContent = "";
            const cpvFilter = document.getElementById("cpvFilter").value.toLowerCase();
            const importeFilterValue = document.getElementById("importeFilter").value;
            const importeFilter = importeFilterValue ? convertToNumber(importeFilterValue) : 0;
            const clienteFilter = document.getElementById("clienteFilter").value.toLowerCase();
            const expedienteFilter = document.getElementById("expedienteFilter").value.toLowerCase();
            const ciudadFilter = document.getElementById("ciudadFilter").value.toLowerCase();
            const estadoFilter = document.getElementById("estadoFilter").value;
            const procedimientoFilter = document.getElementById("procedimientoFilter").value;
            const tipoFilter = document.getElementById("tipoFilter").value;

            entries.sort((a, b) => {
                if (a.feedName === "Contratos Menores" && b.feedName !== "Contratos Menores") {
                    return 1;
                }
                if (a.feedName !== "Contratos Menores" && b.feedName === "Contratos Menores") {
                    return -1;
                }
                return 0;
            });

            entries.forEach(entry => {
                const title = entry.querySelector("title")?.textContent || "N/A";
                const updated = entry.querySelector("updated")?.textContent || "N/A";
                const link = entry.querySelector("link")?.getAttribute("href") || "#";
                const importeElement = entry.getElementsByTagName("cbc:TotalAmount")[0];
                const importe = importeElement ? parseFloat(importeElement.textContent) : 0;
                const formattedImporte = formatPrice(importe);
                const clienteElement = entry.getElementsByTagName("cac:PartyName")[0];
                const clienteName = clienteElement ? clienteElement.getElementsByTagName("cbc:Name")[0]?.textContent : "N/A";
                const buyerProfileElement = entry.getElementsByTagName("cbc:BuyerProfileURIID")[0];
                const buyerProfile = buyerProfileElement
                    ? `<a href='${buyerProfileElement.textContent}' target='_blank' class='ver-perfil'><i class="fas fa-external-link-alt"></i> Ver Perfil</a>`
                    : "N/A";
                const cpvElements = entry.getElementsByTagName("cbc:ItemClassificationCode");
                const cpvs = Array.from(cpvElements).map(el => el.textContent.toLowerCase());
                const documentElements = entry.getElementsByTagNameNS("*", "Attachment");
                const documentos = Array.from(documentElements).map((doc, index) => {
                    const docIdElement = doc.parentElement.getElementsByTagNameNS("*", "ID")[0];
                    const docName = docIdElement ? docIdElement.textContent : `Documento ${index + 1}`;
                    const uriElement = doc.getElementsByTagNameNS("*", "URI")[0];
                    return uriElement ? `<a href='${uriElement.textContent}' target='_blank'>${docName}</a>` : "";
                });
                const documentosHTML = documentos.length > 0
                    ? `<button class='toggle-button' onclick='toggleVisibility(this)'><i class="fas fa-file"></i> Documentos</button><div class='document-list'>${documentos.join("<br>")}</div>`
                    : "";
                const procedureCodeElement = entry.getElementsByTagName("cbc:ProcedureCode")[0];
                const procedureCode = procedureCodeElement ? procedureCodeMapping[procedureCodeElement.textContent] || "N/A" : "N/A";
                const contractNotificationElement = entry.getElementsByTagName("cbc:ContractFolderID")[0];
                const contractNotification = contractNotificationElement ? contractNotificationElement.textContent : "N/A";
                const additionalPublicationElement = entry.getElementsByTagName("cac-place-ext:AdditionalPublicationDocumentReference")[0];
                const fechaAnuncio = additionalPublicationElement
                    ? formatDate(additionalPublicationElement.getElementsByTagName("cbc:IssueDate")[0]?.textContent)
                    : "N/A";
                const participationRequestReceptionPeriod = entry.getElementsByTagName("cac:TenderSubmissionDeadlinePeriod")[0];
                const fechaFinalElement = participationRequestReceptionPeriod ? participationRequestReceptionPeriod.getElementsByTagName("cbc:EndDate")[0] : null;
                const horaFinalElement = participationRequestReceptionPeriod ? participationRequestReceptionPeriod.getElementsByTagName("cbc:EndTime")[0] : null;
                let fechaFinal = "N/A";
                let horaFinal = "N/A";

                if (fechaFinalElement && fechaFinalElement.textContent) {
                    const fechaCompleta = fechaFinalElement.textContent.trim();
                    const [year, month, day] = fechaCompleta.split('-');
                    fechaFinal = `${day}/${month}/${year}`;
                }

                if (horaFinalElement && horaFinalElement.textContent) {
                    const horaCompleta = horaFinalElement.textContent.trim();
                    const [hours, minutes] = horaCompleta.split(':');
                    horaFinal = `${hours}:${minutes}`;
                }

                const estadoElement = entry.getElementsByTagName("cbc-place-ext:ContractFolderStatusCode")[0];
                const estadoCode = estadoElement ? estadoElement.textContent : "N/A";
                const estado = estadoMapping[estadoCode] || "N/A";
                const estadoClass = estado === "Anuncio Previo"
                    ? "estado-anuncio"
                    : estado === "EN PLAZO"
                    ? "estado-en-plazo"
                    : "estado-otros";
                const tipoElement = entry.getElementsByTagName("cbc:TypeCode")[0];
                const tipoCode = tipoElement ? tipoElement.textContent : "N/A";
                const tipo = tipoMapping[tipoCode] || "N/A";
                const ciudadElement = entry.getElementsByTagName("cbc:CityName")[0];
                const ciudad = ciudadElement ? ciudadElement.textContent : "N/A";
                const loteElements = entry.getElementsByTagName("cac:ProcurementProjectLot");
                const lotes = Array.from(loteElements).map(lote => {
                    const idLote = lote.getElementsByTagName("cbc:ID")[0]?.textContent || "N/A";
                    const precioElement = lote.getElementsByTagName("cbc:TaxExclusiveAmount")[0];
                    const precio = precioElement ? formatPrice(parseFloat(precioElement.textContent)) : "N/A";
                    return { idLote, precio };
                });
                const telefonoElement = entry.getElementsByTagName("cbc:Telephone")[0];
                const telefono = telefonoElement ? telefonoElement.textContent : null;
                const emailElement = entry.getElementsByTagName("cbc:ElectronicMail")[0];
                const email = emailElement ? emailElement.textContent : null;
                const contactoHTML = (telefono || email)
                    ? `<p class="contacto">
                            ${telefono ? `<span><i class="fas fa-phone"></i> ${telefono}</span>` : ""}
                            ${email ? `<span><i class="fas fa-envelope"></i> ${email}</span>` : ""}
                        </p>`
                    : "";

                if ((cpvFilter === "" || cpvs.some(cpv => cpv.includes(cpvFilter))) &&
                    (importe >= importeFilter) &&
                    (clienteFilter === "" || clienteName.toLowerCase().includes(clienteFilter)) &&
                    (expedienteFilter === "" || contractNotification.toLowerCase().includes(expedienteFilter)) &&
                    (ciudadFilter === "" || ciudad.toLowerCase().includes(ciudadFilter)) &&
                    (estadoFilter === "" || estado === estadoFilter) &&
                    (procedimientoFilter === "" || procedureCode === procedimientoFilter) &&
                    (tipoFilter === "" || tipoCode === tipoFilter)) {
                    const cpvsToShow = cpvs.slice(0, 3);
                    const cpvsHidden = cpvs.slice(3);
                    const cpvsHTML = cpvsToShow.join(", ");
                    const cpvsHiddenHTML = cpvsHidden.length > 0
                        ? `<div class="cpv"><button class='toggle-cpv' onclick='toggleCPVVisibility(this)'><i class="fas fa-plus"></i></button><div class='cpv-list-hidden'>${cpvsHidden.join(", ")}</div></div>`
                        : "";
                    const lotesHTML = lotes.length > 0
                        ? `<p class="lote"><strong>Lotes:</strong><br>${lotes.map(lote => `Lote ${lote.idLote}: ${lote.precio}`).join("<br>")}</p>`
                        : "";
                    const esOtraPlataforma = entry.feedName === "Otras Plataformas";
                    cardsContent += `<div class="card ${esOtraPlataforma ? 'ext' : ''}">
                        <div class="card-header">
                            <div class="expediente"><strong>Nº Exp: ${contractNotification}</strong></div>
                            <span class="actualizado">Actualizado: ${formatShortDate(updated)}</span>
                        </div>
                        <p class="tipo"><strong>${tipo}</strong></p>
                        <p class="objeto">${title}</p>
                        ${lotesHTML}
                        <p class="cpv">CPV: ${cpvsHTML} ${cpvsHiddenHTML}</p>
                        <p class="cliente"><i class="fas fa-building"></i> ${clienteName} <span class="ver-perfil">${buyerProfile}</span></p>
                        ${contactoHTML}
                        <hr class="divider">
                        <div class="card-details">
                            <p><i class="fas fa-box"></i> ${procedureCode}</p>
                            <p><i class="fas fa-info-circle"></i> <span class="${estadoClass}">${estado}</span></p>
                            <p><i class="fas fa-credit-card"></i> ${formattedImporte}</p>
                            <p><i class="fas fa-calendar-alt"></i> ${fechaFinal} <i class="fas fa-clock" style="color: #777;"></i> ${horaFinal}</p>
                            <p><i class="fas fa-map-marker-alt"></i> ${ciudad}</p>
                        </div>
                        <a href='${link}' target='_blank' class='ver-licitacion-button'>Ver Licitación</a>
                        ${documentosHTML}
                    </div>`;
                }
            });
            document.getElementById("licitacionesContainer").innerHTML = cardsContent;
        } catch (error) {
            console.error(error);
            document.getElementById("error").innerText = `❌ Error en fetchAndDisplayLicitaciones: ${error.message}`;
        }
    }
        document.getElementById("toggleAtomButton").addEventListener("click", () => {
            const atomControls = document.getElementById("atomControls");
            atomControls.classList.toggle("visible");
        });
        window.onload = async function () {
			loadSwitchStates();
			await loadSelectedFeeds();
        };
    </script>
</body>
</html>
