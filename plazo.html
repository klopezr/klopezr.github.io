<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Plazos LCSP </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .timeline-container::before { content: ''; position: absolute; top: 0; left: 19px; height: 100%; width: 2px; background: #e2e8f0; z-index: 0; }
        @media (min-width: 768px) { .timeline-container::before { left: 50%; transform: translateX(-50%); } }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="range"] { accent-color: #3b82f6; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .cal-day-header { text-align: center; font-size: 0.75rem; font-weight: 700; color: #64748b; padding: 0.5rem 0; text-transform: uppercase; }
        .cal-cell { aspect-ratio: 1; border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; cursor: pointer; transition: all 0.2s; font-size: 0.875rem; font-weight: 500; color: #334155; border: 1px solid transparent; background: white; }
        .cal-cell:hover { border-color: #cbd5e1; transform: scale(1.05); z-index: 10; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .cal-cell.empty { background: transparent; cursor: default; border: none; box-shadow: none; transform: none; }
        .cal-indicator-multi { display: flex; gap: 2px; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 80%; justify-content: center; }
        .indicator-dot { height: 4px; flex: 1; border-radius: 2px; }
        .holiday-marker { position: absolute; top: 2px; right: 2px; width: 6px; height: 6px; border-radius: 50%; background-color: #ef4444; box-shadow: 0 0 0 1px white; }
        .tooltip { visibility: hidden; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; text-align: center; padding: 6px 10px; border-radius: 6px; z-index: 50; width: max-content; max-width: 250px; font-size: 0.75rem; font-weight: 400; line-height: 1.4; opacity: 0; transition: opacity 0.2s; margin-bottom: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); pointer-events: none; }
        .tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #1e293b transparent transparent transparent; }
        .cal-cell:hover .tooltip { visibility: visible; opacity: 1; }
        .emergency-badge { background: #7f1d1d; color: #fecaca; }
        .urgent-badge { background: #854d0e; color: #fef9c3; }
        .ordinary-badge { background: #14532d; color: #dcfce7; }
    </style>
</head>
<body class="text-slate-800 antialiased min-h-screen pb-20">
    <div class="max-w-6xl mx-auto px-4 pt-10">
        <div class="text-center mb-10">
            <h1 class="text-3xl md:text-5xl font-extrabold text-slate-900 mb-4 tracking-tight">Simulador</h1>
            <p class="text-slate-600 max-w-2xl mx-auto">Plazos seg√∫n Ley 9/2017 LCSP</p>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8 mb-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500"></div>
            <form id="lcspForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Procedimiento</label>
                        <select id="procManual" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 bg-slate-50 outline-none transition-all">
                            <option value="AUTO">Autom√°tico (Seg√∫n valor)</option>
                            <option value="ABIERTO_SARA">Abierto (SARA)</option>
                            <option value="ABIERTO_NO_SARA">Abierto (No SARA)</option>
                            <option value="SIMPLIFICADO">Abierto Simplificado</option>
                            <option value="SUPERSIMPLIFICADO">Abierto Super Simplificado</option>
                            <option value="MENOR">Contrato Menor</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Tipo de Contrato</label>
                        <select id="tipoContrato" required class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 bg-slate-50 outline-none transition-all">
                            <option value="">Seleccione...</option>
                            <option value="obras">Obras</option>
                            <option value="servicios">Servicios</option>
                            <option value="suministros">Suministros</option>
                            <option value="concesion_obras">Concesi√≥n de Obras</option>
                            <option value="concesion_servicios">Concesi√≥n de Servicios</option>
                            <option value="mixto">Contrato Mixto</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Valor Estimado (‚Ç¨)</label>
                        <input type="number" id="valorEstimado" min="0" step="0.01" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 bg-slate-50 outline-none transition-all">
                    </div>
                </div>

                <div id="mixtoPrincipalContainer" class="hidden">
                    <label class="block text-sm font-bold text-slate-700 mb-2">Prestaci√≥n principal del contrato mixto (art. 18 LCSP)</label>
                    <select id="mixtoPrincipal" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 bg-slate-50 outline-none transition-all">
                        <option value="obras">Obras</option>
                        <option value="servicios">Servicios</option>
                        <option value="suministros">Suministros</option>
                        <option value="concesion_obras">Concesi√≥n de Obras</option>
                        <option value="concesion_servicios">Concesi√≥n de Servicios</option>
                    </select>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start border-t border-slate-100 pt-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Tipo de tramitaci√≥n</label>
                        <select id="tipoTramitacion" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 bg-slate-50 outline-none transition-all">
                            <option value="ordinaria" selected>Ordinaria</option>
                            <option value="urgente">Urgente (art. 119 LCSP)</option>
                            <option value="emergencia">Emergencia (art. 120 LCSP)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Fecha Publicaci√≥n Anuncio</label>
                        <input type="date" id="fechaAnuncio" required class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 bg-slate-50 outline-none transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Configuraci√≥n de Sobres</label>
                        <select id="numSobres" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 bg-slate-50 outline-none transition-all">
                            <option value="3">3 Sobres (Admin, Juicios, F√≥rmulas)</option>
                            <option value="2">2 Sobres (Juicios, F√≥rmulas)</option>
                            <option value="1">1 Sobre √önico</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 items-start">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Tipo de Entidad</label>
                        <select id="tipoEntidad" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 bg-slate-50 outline-none transition-all">
                            <option value="OTRAS" selected>Otras entidades (CCAA, EELL, etc.)</option>
                            <option value="AGE">Administraci√≥n General del Estado</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Comunidad Aut√≥noma</label>
                        <select id="ccaa" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-blue-500 bg-slate-50 outline-none transition-all">
                            <option value="ALL">Nacional (solo festivos nacionales)</option>
                            <option value="ES-AN">Andaluc√≠a</option>
                            <option value="ES-AR">Arag√≥n</option>
                            <option value="ES-AS">Asturias</option>
                            <option value="ES-CN">Canarias</option>
                            <option value="ES-CB">Cantabria</option>
                            <option value="ES-CL">Castilla y Le√≥n</option>
                            <option value="ES-CM">Castilla-La Mancha</option>
                            <option value="ES-CT">Catalu√±a</option>
                            <option value="ES-CE">Ceuta</option>
                            <option value="ES-EX">Extremadura</option>
                            <option value="ES-GA">Galicia</option>
                            <option value="ES-IB">Islas Baleares</option>
                            <option value="ES-RI">La Rioja</option>
                            <option value="ES-MD">Madrid</option>
                            <option value="ES-ML">Melilla</option>
                            <option value="ES-MC">Murcia</option>
                            <option value="ES-NC">Navarra</option>
                            <option value="ES-PV">Pa√≠s Vasco</option>
                            <option value="ES-VC">Valenciana</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 flex items-end">
                        <label class="flex items-center space-x-3 cursor-pointer group">
                            <input type="checkbox" id="bajaAnormal" class="w-6 h-6 rounded-md border-slate-300 text-blue-600 focus:ring-blue-500 transition-all">
                            <span class="text-sm font-bold text-slate-800">Tr√°mite de Baja Temeraria (Art. 149 LCSP)</span>
                        </label>
                    </div>
                </div>

                <button type="submit" class="w-full bg-slate-900 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-colors text-lg">
                    Generar L√≠nea Base
                </button>
            </form>
        </div>

        <div id="resultsContainer" class="hidden space-y-8">
            <div class="bg-indigo-50 border border-indigo-100 rounded-2xl p-6 text-center shadow-sm fade-in">
                <div class="flex flex-wrap gap-2 justify-center mb-3">
                    <span id="tagSara" class="hidden inline-block px-3 py-1 rounded-full bg-indigo-200 text-indigo-900 font-bold text-xs uppercase tracking-widest">Sujeto a Regulaci√≥n Armonizada</span>
                    <span id="tramitacionBadge" class="inline-block px-3 py-1 rounded-full font-bold text-xs uppercase tracking-widest"></span>
                </div>
                <h2 id="procName" class="text-3xl font-black text-indigo-950 mb-1"></h2>
                <p id="procDetail" class="text-indigo-800 text-sm font-medium"></p>
            </div>

            <div id="urgentInfo" class="hidden bg-amber-50 border border-amber-200 rounded-xl p-4 text-sm text-amber-800 fade-in">
                <p class="font-bold mb-1">‚ö° Tramitaci√≥n urgente (art. 119 LCSP)</p>
                <p>Los plazos de presentaci√≥n de proposiciones y de adjudicaci√≥n se reducen a la mitad, excepto el plazo de formalizaci√≥n (15 d√≠as h√°biles en SARA no se reduce) y los plazos de los procedimientos simplificados. Los plazos de los sliders son orientativos, respetando los m√°ximos legales.</p>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8 fade-in">
                <h3 class="text-xl font-bold text-slate-900 mb-10 text-center uppercase tracking-wide border-b pb-4">Secuencia de Tr√°mites y Ajustes</h3>
                <div class="relative timeline-container" id="timelineList"></div>
                <div class="mt-8 p-4 bg-blue-50 rounded-xl border border-blue-200 text-sm text-blue-800">
                    <p class="font-bold mb-1">üìÖ Nota sobre d√≠as h√°biles:</p>
                    <p>Los plazos indicados como "d√≠as h√°biles" excluyen s√°bados, domingos y festivos (nacionales y auton√≥micos seg√∫n selecci√≥n). En el calendario, estos d√≠as aparecen sin color de fondo (blanco) para que puedas contar visualmente los d√≠as h√°biles coloreados. Los festivos tienen un punto rojo. Al pasar el cursor se detalla el tipo de c√≥mputo y el nombre del festivo.</p>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8 fade-in">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 border-b pb-4">
                    <h3 class="text-xl font-bold text-slate-900 uppercase tracking-wide">Calendario Din√°mico</h3>
                    <div class="flex flex-wrap gap-3">
                        <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-full bg-slate-400"></div><span class="text-xs font-bold text-slate-600">Publicaci√≥n</span></div>
                        <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-full bg-blue-500"></div><span class="text-xs font-bold text-slate-600">Presentaci√≥n</span></div>
                        <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-full bg-purple-500"></div><span class="text-xs font-bold text-slate-600">Mesas/Eval</span></div>
                        <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-full bg-red-500"></div><span class="text-xs font-bold text-slate-600">Bajas</span></div>
                        <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-full bg-amber-500"></div><span class="text-xs font-bold text-slate-600">Adjudicaci√≥n</span></div>
                        <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-full bg-emerald-500"></div><span class="text-xs font-bold text-slate-600">Formalizaci√≥n</span></div>
                    </div>
                </div>
                <div id="calendarsContainer" class="space-y-10"></div>
            </div>
        </div>
    </div>

    <script>
        const thresholds = {
            obras: { menor: 40000, supersimp: 80000, simp: 2000000, sara: 5404000, pres: 26 },
            servicios: { menor: 15000, supersimp: 60000, simp: 140000, sara: 140000, pres: 15 },
            suministros: { menor: 15000, supersimp: 60000, simp: 140000, sara: 140000, pres: 15 },
            concesion_obras: { menor: 40000, supersimp: 0, simp: 0, sara: 5404000, pres: 26 },
            concesion_servicios: { menor: 15000, supersimp: 0, simp: 0, sara: 5404000, pres: 26 },
            mixto: { menor: 15000, supersimp: 60000, simp: 140000, sara: 5404000, pres: 15 }
        };

        const themeColors = { 'gray': 'bg-slate-400', 'blue': 'bg-blue-500', 'purple': 'bg-purple-500', 'red': 'bg-red-500', 'amber': 'bg-amber-500', 'emerald': 'bg-emerald-500' };
        const ringColors = { 'gray': 'ring-slate-200', 'blue': 'ring-blue-200', 'purple': 'ring-purple-200', 'red': 'ring-red-200', 'amber': 'ring-amber-200', 'emerald': 'ring-emerald-200' };
        const textColors = { 'gray': 'text-slate-700', 'blue': 'text-blue-700', 'purple': 'text-purple-700', 'red': 'text-red-700', 'amber': 'text-amber-700', 'emerald': 'text-emerald-700' };

        let currentSkeleton = [];
        let globalT0 = new Date();
        let holidayMap = new Map();

        document.getElementById('fechaAnuncio').valueAsDate = new Date();
        document.getElementById('procManual').addEventListener('change', (e) => {
            if (e.target.value === 'SUPERSIMPLIFICADO') {
                document.getElementById('numSobres').value = '1';
                document.getElementById('numSobres').disabled = true;
            } else {
                document.getElementById('numSobres').disabled = false;
            }
        });

        document.getElementById('tipoContrato').addEventListener('change', (e) => {
            if (e.target.value === 'mixto') {
                document.getElementById('mixtoPrincipalContainer').classList.remove('hidden');
            } else {
                document.getElementById('mixtoPrincipalContainer').classList.add('hidden');
            }
        });

        function getViernesSanto(year) {
            const a = year % 19, b = Math.floor(year / 100), c = year % 100;
            const d = Math.floor(b / 4), e = b % 4, f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3), h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4), k = c % 4, l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
            const day = ((h + l - 7 * m + 114) % 31) + 1;
            const vs = new Date(year, month, day);
            vs.setDate(vs.getDate() - 2);
            return vs;
        }

        function getHolidayInfo(date) {
            const d = date.getDate(), m = date.getMonth(), y = date.getFullYear();
            if (m === 0 && d === 1) return { name: 'A√±o Nuevo', type: 'Nacional' };
            if (m === 0 && d === 6) return { name: 'Epifan√≠a del Se√±or', type: 'Nacional' };
            if (m === 4 && d === 1) return { name: 'Fiesta del Trabajo', type: 'Nacional' };
            if (m === 7 && d === 15) return { name: 'Asunci√≥n de la Virgen', type: 'Nacional' };
            if (m === 9 && d === 12) return { name: 'Fiesta Nacional de Espa√±a', type: 'Nacional' };
            if (m === 10 && d === 1) return { name: 'Todos los Santos', type: 'Nacional' };
            if (m === 11 && d === 6) return { name: 'D√≠a de la Constituci√≥n Espa√±ola', type: 'Nacional' };
            if (m === 11 && d === 8) return { name: 'Inmaculada Concepci√≥n', type: 'Nacional' };
            if (m === 11 && d === 25) return { name: 'Natividad del Se√±or', type: 'Nacional' };
            const vs = getViernesSanto(y);
            if (m === vs.getMonth() && d === vs.getDate()) return { name: 'Viernes Santo', type: 'Nacional' };
            const dateStr = date.toDateString();
            if (holidayMap.has(dateStr)) return holidayMap.get(dateStr);
            return null;
        }

        async function loadHolidaysForYear(year, region) {
            let holidays = [];
            try {
                const response = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/ES`);
                if (!response.ok) throw new Error('Error fetching holidays');
                let data = await response.json();
                data.forEach(h => {
                    if (region === 'ALL') {
                        if (h.global === true) {
                            holidays.push({ date: new Date(h.date).toDateString(), name: h.localName, type: 'Nacional' });
                        }
                    } else {
                        if (h.global === true) {
                            holidays.push({ date: new Date(h.date).toDateString(), name: h.localName, type: 'Nacional' });
                        }
                        if (h.counties && h.counties.includes(region)) {
                            holidays.push({ date: new Date(h.date).toDateString(), name: h.localName, type: 'Auton√≥mico' });
                        }
                    }
                });
            } catch (error) {
                console.warn('Error cargando festivos, usando solo nacionales fijos', error);
            }
            return holidays;
        }

        function addDays(date, days) { const d = new Date(date); d.setDate(d.getDate() + days); return d; }
        function addHabiles(date, numHabiles) {
            const d = new Date(date); let added = 0;
            while (added < numHabiles) { 
                d.setDate(d.getDate() + 1); 
                if (d.getDay() !== 0 && d.getDay() !== 6 && !getHolidayInfo(d)) added++; 
            }
            return d;
        }
        function formatDate(date) { return date.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' }); }
        function getMonthName(m, y) { return new Date(y, m, 1).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }); }

        function buildSkeleton(proc, tipo, sara, nSobres, hasBaja, tInfo, entidad, tramitacion) {
            let s = [];
            
            s.push({ id: 'pub', name: 'Publicaci√≥n del anuncio', color: 'gray', art: 'Art. 135 LCSP', getDesc: () => {
                let pubInfo = 'Publicaci√≥n en perfil de contratante';
                if (sara) pubInfo += ' y en DOUE';
                if (proc === 'ABIERTO_SARA' || proc === 'ABIERTO_NO_SARA' || proc === 'SIMPLIFICADO') {
                    if (entidad === 'AGE') pubInfo += ' y en BOE';
                }
                return pubInfo;
            }, staticDur: 0, isHabiles: false });

            if (tramitacion === 'emergencia') {
                s.push({ id: 'emergencia', name: 'ACUERDO DE EMERGENCIA', color: 'red', art: 'Art. 120 LCSP', getDesc: () => 'R√©gimen excepcional. Se act√∫a de inmediato. Plazo m√°ximo inicio ejecuci√≥n: 1 mes.', staticDur: 0, isHabiles: false });
                s.push({ id: 'ejecucion', name: 'Inicio ejecuci√≥n (m√°x. 1 mes)', color: 'amber', art: 'Art. 120.1.c', getDesc: () => 'La ejecuci√≥n debe iniciarse en el plazo m√°ximo de 1 mes desde el acuerdo.', staticDur: 30, isHabiles: false });
                s.push({ id: 'regularizacion', name: 'Regularizaci√≥n posterior', color: 'emerald', art: 'Art. 120.1.d', getDesc: () => 'Finalizada la emergencia, se aplican reglas de cumplimiento, recepci√≥n y liquidaci√≥n.', staticDur: 0, isHabiles: false });
                return s;
            }

            if (proc === 'MENOR') {
                s.push({ id: 'menor', name: 'Adjudicaci√≥n Directa', color: 'emerald', art: 'Art. 118', getDesc: () => 'Contrato menor: Aprobaci√≥n de gasto y factura. Plazo no regulado.', staticDur: 0, isHabiles: false });
                return s;
            }

            if (proc === 'SUPERSIMPLIFICADO') {
                s.push({ id: 'pres', name: 'Presentaci√≥n Proposiciones', color: 'blue', art: 'Art. 159.6.b', getDesc: () => 'Plazo fijado de 10 d√≠as h√°biles (m√≠nimo legal).', staticDur: 10, isHabiles: true });
                s.push({ id: 'm1', name: 'Mesa: Apertura y Evaluaci√≥n', color: 'purple', art: 'Art. 159.6.d', getDesc: (v) => `Propuesta en ${v} d√≠as h√°biles. L√≠mite legal: m√°ximo 5 d√≠as (art. 159.6.d).`, slider: { id: 'sl_m1', min: 1, max: 5, val: 3, label: 'D√≠as hasta Mesa', txt: 'M√°ximo legal 5 d√≠as h√°biles. M√≠nimo: 1 d√≠a (orientativo).' }, isHabiles: true });
                s.push({ id: 'form', name: 'Formalizaci√≥n Inmediata', color: 'emerald', art: 'Art. 159.6.g', getDesc: () => 'Firma de aceptaci√≥n de la resoluci√≥n de adjudicaci√≥n. Sin plazo adicional.', staticDur: 0, isHabiles: true });
                return s;
            }

            let pDays = sara ? (tipo.includes('concesion') ? 30 : 35) : (proc === 'SIMPLIFICADO' ? (tipo === 'obras' ? 20 : 15) : tInfo.pres);
            
            if (tramitacion === 'urgente') {
                if (sara && (tipo === 'concesion_obras' || tipo === 'concesion_servicios')) {
                } else if (proc === 'SIMPLIFICADO') {
                } else if (sara && (proc === 'ABIERTO_SARA' || proc === 'ABIERTO_NO_SARA')) {
                    if (tipo.includes('concesion')) {
                    } else {
                        pDays = Math.ceil(pDays / 2);
                    }
                } else {
                    pDays = Math.ceil(pDays / 2);
                }
            }

            let artPresent = sara ? (tipo.includes('concesion') ? 'Art. 156.2 (concesiones)' : 'Art. 156.2') : (proc === 'SIMPLIFICADO' ? 'Art. 159.3' : 'Art. 156.3');
            if (tramitacion === 'urgente') artPresent += ' + art.119 (urgencia)';
            
            s.push({ id: 'pres', name: 'Presentaci√≥n Proposiciones', color: 'blue', art: artPresent, getDesc: () => `Plazo fijado de ${pDays} d√≠as naturales.`, staticDur: pDays, isHabiles: false });

            let maxMesa = (proc === 'SIMPLIFICADO' && tramitacion !== 'urgente') ? 7 : 20;
            let defMesa = 3;
            
            if (nSobres === 3) {
                s.push({ id: 'm1', name: 'Mesa 1: Administrativa y Juicios', color: 'purple', art: (tramitacion === 'urgente' ? 'Art. 119 + ' : '') + 'Art. 157 / 159', getDesc: (v) => `Apertura en ${v} d√≠as h√°biles. En simplificado m√°ximo 7 d√≠as (art. 159.4.e).`, slider: { id: 'sl_m1', min: 1, max: maxMesa, val: defMesa, label: 'D√≠as hasta Mesa 1', txt: (proc === 'SIMPLIFICADO' ? 'M√°x. 7 d√≠as h√°biles. M√≠nimo 1 d√≠a.' : 'Plazo orientativo (no hay m√°ximo legal).') }, isHabiles: true });
                s.push({ id: 'ev', name: 'Evaluaci√≥n T√©cnica (Sobre B)', color: 'purple', art: (tramitacion === 'urgente' ? 'Art. 119 + ' : '') + 'Art. 157.4 / 159.4.e', getDesc: (v) => `Informe t√©cnico en ${v} d√≠as h√°biles. L√≠mite legal en simplificado: 7 d√≠as (art. 159.4.e).`, slider: { id: 'sl_ev', min: 1, max: (proc === 'SIMPLIFICADO' && tramitacion !== 'urgente') ? 7 : 30, val: (proc === 'SIMPLIFICADO') ? 3 : 7, label: 'D√≠as de Evaluaci√≥n', txt: (proc === 'SIMPLIFICADO' ? 'M√°x. 7 d√≠as h√°biles. M√≠nimo 1 d√≠a.' : 'Plazo orientativo.') }, isHabiles: true });
                s.push({ id: 'm2', name: 'Mesa 2: F√≥rmulas (Sobre C)', color: 'purple', art: (tramitacion === 'urgente' ? 'Art. 119 + ' : '') + 'Art. 157.4', getDesc: (v) => `Apertura econ√≥mica en ${v} d√≠as h√°biles.`, slider: { id: 'sl_m2', min: 1, max: maxMesa, val: defMesa, label: 'D√≠as hasta Mesa 2', txt: 'Tras recibir informe. Sin m√°ximo legal.' }, isHabiles: true });
            } else if (nSobres === 2) {
                s.push({ id: 'm1', name: 'Mesa 1: Juicios de Valor', color: 'purple', art: (tramitacion === 'urgente' ? 'Art. 119 + ' : '') + 'Art. 157 / 159', getDesc: (v) => `Apertura en ${v} d√≠as h√°biles. En simplificado m√°ximo 7 d√≠as (art. 159.4.e).`, slider: { id: 'sl_m1', min: 1, max: maxMesa, val: defMesa, label: 'D√≠as hasta Mesa 1', txt: (proc === 'SIMPLIFICADO' ? 'M√°x. 7 d√≠as h√°biles. M√≠nimo 1 d√≠a.' : 'Plazo orientativo.') }, isHabiles: true });
                s.push({ id: 'ev', name: 'Evaluaci√≥n T√©cnica', color: 'purple', art: (tramitacion === 'urgente' ? 'Art. 119 + ' : '') + 'Art. 157.4 / 159.4.e', getDesc: (v) => `Informe t√©cnico en ${v} d√≠as h√°biles. L√≠mite legal en simplificado: 7 d√≠as (art. 159.4.e).`, slider: { id: 'sl_ev', min: 1, max: (proc === 'SIMPLIFICADO' && tramitacion !== 'urgente') ? 7 : 30, val: (proc === 'SIMPLIFICADO') ? 3 : 7, label: 'D√≠as de Evaluaci√≥n', txt: (proc === 'SIMPLIFICADO' ? 'M√°x. 7 d√≠as h√°biles. M√≠nimo 1 d√≠a.' : 'Plazo orientativo.') }, isHabiles: true });
                s.push({ id: 'm2', name: 'Mesa 2: F√≥rmulas', color: 'purple', art: (tramitacion === 'urgente' ? 'Art. 119 + ' : '') + 'Art. 157.4 / 159.4.f', getDesc: (v) => `Apertura econ√≥mica en ${v} d√≠as h√°biles.`, slider: { id: 'sl_m2', min: 1, max: maxMesa, val: defMesa, label: 'D√≠as hasta Mesa 2', txt: 'Tras recibir informe. Sin m√°ximo legal.' }, isHabiles: true });
            } else {
                s.push({ id: 'm1', name: 'Mesa √önica: F√≥rmulas', color: 'purple', art: (tramitacion === 'urgente' ? 'Art. 119 + ' : '') + 'Art. 157 / 159', getDesc: (v) => `Apertura p√∫blica en ${v} d√≠as h√°biles.`, slider: { id: 'sl_m1', min: 1, max: maxMesa, val: defMesa, label: 'D√≠as hasta Mesa', txt: (proc === 'SIMPLIFICADO' ? 'M√°x. 7 d√≠as h√°biles. M√≠nimo 1 d√≠a.' : 'Plazo orientativo.') }, isHabiles: true });
            }

            if (hasBaja && proc !== 'SUPERSIMPLIFICADO') {
                s.push({ id: 'b1', name: 'Identificaci√≥n Baja Temeraria', color: 'red', art: 'Art. 149.4', getDesc: (v) => `Requerimiento en ${v} d√≠as h√°biles.`, slider: { id: 'sl_b1', min: 1, max: 5, val: 1, label: 'D√≠as de Identificaci√≥n', txt: 'Detecci√≥n por la Mesa. Sin plazo legal fijo.' }, isHabiles: true });
                s.push({ id: 'b2', name: 'Audiencia al Licitador', color: 'red', art: 'Art. 149.4', getDesc: (v) => `Justificaci√≥n en ${v} d√≠as h√°biles. M√≠nimo legal: 5 d√≠as.`, slider: { id: 'sl_b2', min: 5, max: 15, val: 5, label: 'Plazo Audiencia', txt: 'M√≠nimo legal 5 d√≠as h√°biles. M√°ximo orientativo 15.' }, isHabiles: true });
                s.push({ id: 'b3', name: 'Informe T√©cnico Baja', color: 'red', art: 'Art. 149.6', getDesc: (v) => `Informe en ${v} d√≠as h√°biles.`, slider: { id: 'sl_b3', min: 1, max: 20, val: 5, label: 'D√≠as de Informe', txt: 'Asesoramiento t√©cnico. Sin plazo legal.' }, isHabiles: true });
            }

            let pReq = proc === 'SUPERSIMPLIFICADO' ? 5 : 10;
            s.push({ id: 'req1', name: 'Requerimiento Doc.', color: 'amber', art: (tramitacion === 'urgente' ? 'Art. 119 + ' : '') + 'Art. 150.2', getDesc: () => 'Aviso al licitador propuesto.', staticDur: 1, isHabiles: true });
            s.push({ id: 'req2', name: 'Aporte Documentaci√≥n', color: 'amber', art: (tramitacion === 'urgente' ? 'Art. 119 + ' : '') + 'Art. 150.2', getDesc: () => `Licitador aporta en ${pReq} d√≠as h√°biles.`, staticDur: pReq, isHabiles: true });
            
            let adjMax = (tramitacion === 'urgente' && sara) ? 3 : 5;
            s.push({ id: 'adj', name: 'Resoluci√≥n Adjudicaci√≥n', color: 'amber', art: (tramitacion === 'urgente' ? 'Art. 119 + ' : '') + 'Art. 150.3', getDesc: (v) => `Adjudicaci√≥n en ${v} d√≠as h√°biles. M√°ximo legal: ${adjMax} d√≠as.`, slider: { id: 'sl_adj', min: 1, max: adjMax, val: adjMax, label: 'Plazo Adjudicaci√≥n', txt: `M√°x. ${adjMax} d√≠as h√°biles. M√≠nimo 1 d√≠a.` }, isHabiles: true });

            if (proc !== 'SUPERSIMPLIFICADO') {
                let espera = (sara && tramitacion !== 'urgente') ? 15 : 15;
                if (tramitacion === 'urgente' && sara) espera = 15;
                else if (tramitacion === 'urgente') espera = 8;
                
                s.push({ id: 'form', name: 'Formalizaci√≥n', color: 'emerald', art: (tramitacion === 'urgente' ? 'Art. 119 + ' : '') + (sara ? 'Art. 153.3' : 'Art. 153.2'), getDesc: () => sara ? (tramitacion === 'urgente' ? '15 d√≠as h√°biles (no se reduce, art.119.2.b.1¬∫)' : '15 d√≠as h√°biles (plazo recurso especial)') : `Firma m√°x. ${espera} d√≠as h√°biles.`, staticDur: espera, isHabiles: true });
            }

            return s;
        }

        function renderTimelineBase() {
            let htmlList = '';
            currentSkeleton.forEach((ev, i) => {
                const alignLeft = i % 2 === 0;
                const cBg = themeColors[ev.color]; const cRing = ringColors[ev.color]; const cText = textColors[ev.color];
                
                let sliderHtml = '';
                if (ev.slider) {
                    sliderHtml = `
                    <div class="mt-4 bg-slate-50 border border-slate-200 rounded-xl p-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-slate-700 uppercase tracking-wide">${ev.slider.label}</label>
                            <span class="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded" id="val-${ev.id}">${ev.slider.val} d√≠as</span>
                        </div>
                        <input type="range" id="${ev.slider.id}" data-evid="${ev.id}" min="${ev.slider.min}" max="${ev.slider.max}" value="${ev.slider.val}" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer lcsp-slider">
                        <p class="text-[10px] text-slate-500 mt-2 font-medium">${ev.slider.txt}</p>
                    </div>`;
                }

                htmlList += `
                    <div class="relative w-full mb-8 flex justify-center md:justify-${alignLeft ? 'start' : 'end'} items-center group">
                        <div class="hidden md:block absolute left-1/2 transform -translate-x-1/2 w-4 h-4 rounded-full ${cBg} ring-4 ${cRing} z-10 transition-transform group-hover:scale-125"></div>
                        <div class="absolute md:hidden left-0 top-6 w-4 h-4 rounded-full ${cBg} ring-4 ${cRing} z-10 ml-4.5 transition-transform group-hover:scale-125"></div>
                        <div class="w-full md:w-[45%] pl-12 md:pl-0 ${alignLeft ? 'md:pr-10' : 'md:pl-10'}">
                            <div class="bg-white border border-slate-100 p-5 rounded-2xl shadow-sm hover:shadow-md transition-shadow">
                                <h4 class="text-base font-bold text-slate-800 mb-2">${ev.name}</h4>
                                <div class="inline-block px-2 py-1 bg-slate-50 rounded text-xs font-bold text-slate-600 mb-2 border border-slate-200" id="date-${ev.id}"></div>
                                <div class="text-[11px] font-bold uppercase tracking-wider ${cText} mb-1">${ev.art}</div>
                                <p class="text-slate-500 text-xs leading-relaxed" id="desc-${ev.id}"></p>
                                ${sliderHtml}
                            </div>
                        </div>
                    </div>`;
            });
            document.getElementById('timelineList').innerHTML = htmlList;

            document.querySelectorAll('.lcsp-slider').forEach(sl => {
                sl.addEventListener('input', (e) => {
                    const evid = e.target.dataset.evid;
                    document.getElementById(`val-${evid}`).textContent = `${e.target.value} d√≠as`;
                    recalculateDates();
                });
            });
        }

        async function recalculateDates() {
            let curr = new Date(globalT0);
            let calEvents = [];

            for (const ev of currentSkeleton) {
                let dur = ev.slider ? parseInt(document.getElementById(ev.slider.id).value) : ev.staticDur;
                
                document.getElementById(`desc-${ev.id}`).textContent = ev.getDesc(dur);

                let start = new Date(curr);
                let end = new Date(start);
                
                if (dur > 0) {
                    if (ev.isHabiles) end = addHabiles(start, dur);
                    else end = addDays(start, dur);
                }

                curr = new Date(end);

                document.getElementById(`date-${ev.id}`).textContent = start.getTime() === end.getTime() ? formatDate(start) : `${formatDate(start)} ‚ûú ${formatDate(end)}`;
                
                calEvents.push({ name: ev.name, start: start, end: end, color: ev.color, isHabiles: ev.isHabiles });
            }

            renderCalendars(calEvents);
        }

        function renderCalendars(evs) {
            if (evs.length === 0) return;
            let minDate = new Date(Math.min(...evs.map(e => e.start.getTime())));
            let maxDate = new Date(Math.max(...evs.map(e => e.end.getTime())));
            let currMonth = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
            let endMonth = new Date(maxDate.getFullYear(), maxDate.getMonth(), 1);
            let calHtml = '';
            
            while (currMonth <= endMonth) {
                let y = currMonth.getFullYear(); let m = currMonth.getMonth();
                let daysInMonth = new Date(y, m + 1, 0).getDate();
                let fDay = new Date(y, m, 1).getDay(); fDay = fDay === 0 ? 6 : fDay - 1;
                
                calHtml += `<div class="border border-slate-200 rounded-xl overflow-hidden shadow-sm"><div class="bg-slate-50 border-b border-slate-200 px-4 py-3"><h4 class="text-sm font-bold text-slate-700 uppercase tracking-widest text-center">${getMonthName(m, y)}</h4></div><div class="p-4"><div class="cal-grid mb-2"><div class="cal-day-header">L</div><div class="cal-day-header">M</div><div class="cal-day-header">X</div><div class="cal-day-header">J</div><div class="cal-day-header">V</div><div class="cal-day-header text-red-400">S</div><div class="cal-day-header text-red-400">D</div></div><div class="cal-grid">`;
                for (let i = 0; i < fDay; i++) calHtml += `<div class="cal-cell empty"></div>`;
                
                for (let d = 1; d <= daysInMonth; d++) {
                    let cellObj = new Date(y, m, d);
                    let cellTs = cellObj.getTime();
                    let dEvs = evs.filter(ev => cellTs >= ev.start.getTime() && cellTs <= ev.end.getTime());
                    let isWeekend = cellObj.getDay() === 0 || cellObj.getDay() === 6;
                    let holidayInfo = getHolidayInfo(cellObj);
                    let isFestivo = holidayInfo !== null;
                    
                    let inhabil = false;
                    for (let ev of dEvs) {
                        if (ev.isHabiles && (isWeekend || isFestivo)) {
                            inhabil = true;
                            break;
                        }
                    }
                    
                    let bgColor = 'bg-white';
                    if (dEvs.length > 0 && !inhabil) {
                        bgColor = 'bg-slate-50 font-bold border-slate-200';
                    }
                    
                    let inds = ''; 
                    let tt = `<strong>${formatDate(cellObj)}</strong>`;
                    
                    if (isFestivo) tt += `<br/><span class="text-red-300">Festivo: ${holidayInfo.name} (${holidayInfo.type})</span>`;
                    else if (isWeekend) tt += `<br/><span class="text-amber-300">Fin de semana</span>`;
                    
                    if (dEvs.length > 0) {
                        let visibleEvs = dEvs.filter(ev => !(ev.isHabiles && (isWeekend || isFestivo)));
                        if (visibleEvs.length > 0) {
                            inds = visibleEvs.length === 1 ? `<div class="cal-indicator-multi"><div class="indicator-dot ${themeColors[visibleEvs[0].color]}"></div></div>` : `<div class="cal-indicator-multi">${visibleEvs.map(ev => `<div class="indicator-dot ${themeColors[ev.color]}"></div>`).join('')}</div>`;
                        }
                        dEvs.forEach(ev => tt += `<br/>‚Ä¢ ${ev.name} (${ev.isHabiles ? 'h√°biles' : 'naturales'})`);
                    }
                    
                    if (inhabil) {
                        tt += `<br/><span class="text-slate-400">D√≠a inh√°bil para plazos h√°biles</span>`;
                    }
                    
                    let holidayMarker = isFestivo ? '<div class="holiday-marker"></div>' : '';
                    calHtml += `<div class="cal-cell ${bgColor}"><span>${d}</span>${inds}${holidayMarker}<div class="tooltip">${tt}</div></div>`;
                }
                calHtml += `</div></div></div>`;
                currMonth.setMonth(currMonth.getMonth() + 1);
            }
            document.getElementById('calendarsContainer').innerHTML = calHtml;
        }

        document.getElementById('lcspForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const pMan = document.getElementById('procManual').value;
            let tipo = document.getElementById('tipoContrato').value;
            const valor = parseFloat(document.getElementById('valorEstimado').value) || 0;
            const t0Str = document.getElementById('fechaAnuncio').value;
            const nSobres = parseInt(document.getElementById('numSobres').value);
            const hasBaja = document.getElementById('bajaAnormal').checked;
            const entidad = document.getElementById('tipoEntidad').value;
            const tramitacion = document.getElementById('tipoTramitacion').value;
            const ccaa = document.getElementById('ccaa').value;

            if (!tipo || !t0Str) return;

            if (tipo === 'mixto') {
                tipo = document.getElementById('mixtoPrincipal').value;
            }

            globalT0 = new Date(t0Str);
            globalT0.setHours(0,0,0,0);

            let tInfo = JSON.parse(JSON.stringify(thresholds[tipo]));
            if (entidad === 'OTRAS' && (tipo === 'servicios' || tipo === 'suministros')) {
                tInfo.sara = 216000;
                tInfo.simp = 216000;
            }

            let proc = pMan;
            if (pMan === 'AUTO') {
                if (valor < tInfo.menor) proc = 'MENOR';
                else if (tInfo.supersimp > 0 && valor < tInfo.supersimp) proc = 'SUPERSIMPLIFICADO';
                else if (tInfo.simp > 0 && valor < tInfo.simp) proc = 'SIMPLIFICADO';
                else proc = valor >= tInfo.sara ? 'ABIERTO_SARA' : 'ABIERTO_NO_SARA';
            }

            const sara = (proc === 'ABIERTO_SARA') || (pMan === 'AUTO' && valor >= tInfo.sara);

            globalT0.setHours(0,0,0,0);
            let skeleton = buildSkeleton(proc, tipo, sara, nSobres, hasBaja, tInfo, entidad, tramitacion);
            let maxEnd = new Date(globalT0);
            for (let ev of skeleton) {
                if (ev.staticDur) {
                    if (ev.isHabiles) maxEnd = addHabiles(maxEnd, ev.staticDur);
                    else maxEnd = addDays(maxEnd, ev.staticDur);
                }
            }
            let startYear = globalT0.getFullYear();
            let endYear = maxEnd.getFullYear();
            holidayMap.clear();
            for (let y = startYear; y <= endYear; y++) {
                const h = await loadHolidaysForYear(y, ccaa);
                h.forEach(item => holidayMap.set(item.date, { name: item.name, type: item.type }));
            }

            document.getElementById('tagSara').style.display = sara ? 'inline-block' : 'none';
            
            let badge = document.getElementById('tramitacionBadge');
            badge.className = 'inline-block px-3 py-1 rounded-full font-bold text-xs uppercase tracking-widest';
            if (tramitacion === 'urgente') {
                badge.textContent = 'Tramitaci√≥n URGENTE (art. 119)';
                badge.classList.add('urgent-badge');
                document.getElementById('urgentInfo').classList.remove('hidden');
            } else if (tramitacion === 'emergencia') {
                badge.textContent = 'R√©gimen de EMERGENCIA (art. 120)';
                badge.classList.add('emergency-badge');
                document.getElementById('urgentInfo').classList.add('hidden');
            } else {
                badge.textContent = 'Tramitaci√≥n ORDINARIA';
                badge.classList.add('ordinary-badge');
                document.getElementById('urgentInfo').classList.add('hidden');
            }

            document.getElementById('procName').textContent = proc.replace(/_/g, ' ');
            document.getElementById('procDetail').textContent = pMan === 'AUTO' ? `${tipo.replace('_', ' ').toUpperCase()} | Valor: ${valor.toLocaleString('es-ES')} ‚Ç¨ | Entidad: ${entidad}` : `Modo Manual Activo | Entidad: ${entidad}`;

            currentSkeleton = skeleton;
            
            renderTimelineBase();
            await recalculateDates();
            
            document.getElementById('resultsContainer').classList.remove('hidden');
            document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
    </script>
</body>
</html>
